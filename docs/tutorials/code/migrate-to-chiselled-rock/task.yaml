###########################################
# IMPORTANT
# Comments matter!
# The docs use the wrapping comments as 
# markers for including said instructions 
# as snippets in the docs.
###########################################
summary: docker image migration tutorial

execute: |
  date

  sudo snap install rockcraft --classic --edge

  # [docs:build-docker-image]
  DOCKER_BUILDKIT=1 docker build -t dotnet-runtime:reference .
  # [docs:build-docker-image-end]
  
  # [docs:inspect-docker-image]
  docker images dotnet-runtime:reference
  docker run --rm dotnet-runtime:reference dotnet --info
  # [docs:inspect-docker-image-end]

  # [docs:build-rock]
  rockcraft --verbosity debug
  # [docs:build-rock-end]

  test -f dotnet-runtime_chiselled_amd64.rock
  test ! -d work

  uname -a
  snap list

  # test container execution
  docker images

  # [docs:skopeo-copy]
  sudo /snap/rockcraft/current/bin/skopeo --insecure-policy copy oci-archive:dotnet-runtime_chiselled_amd64.rock docker-daemon:dotnet-runtime:chiselled
  # [docs:skopeo-copy-end]
  
  # [docs:inspect-rock]
  docker images dotnet-runtime:chiselled
  docker run --rm dotnet-runtime:chiselled exec dotnet --info
  # [docs:inspect-rock-end]
  
restore: |
  rm dotnet-runtime_chiselled_amd64.rock
  docker rmi -f dotnet-runtime:chiselled dotnet-runtime:reference