###########################################
# IMPORTANT
# Comments matter!
# The docs use the wrapping comments as
# markers for including said instructions
# as snippets in the docs.
###########################################
summary:  test "How to add an internal user" guide

execute: |
  # [docs:chmod-getuser]
  chmod +x cgi-bin/getuser.py
  # [docs:chmod-getuser-end]

  # [docs:pack-rock]
  rockcraft pack
  # [docs:pack-rock-end]

  # [docs:skopeo]
  sudo rockcraft.skopeo --insecure-policy copy oci-archive:internal-user_latest_amd64.rock docker-daemon:internal-user:latest
  # [docs:skopeo-end]

  # [docs:check-user]
  id=$(docker run -d -p 18001:18001 internal-user:latest)
  curl -i http://127.0.0.1:18001/cgi-bin/getuser.py
  docker rm -f "$id"
  # [docs:check-user-end]