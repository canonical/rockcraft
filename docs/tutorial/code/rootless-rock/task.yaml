###########################################
# IMPORTANT
# Comments matter!
# The docs use the wrapping comments as
# markers for including said instructions
# as snippets in the docs.
###########################################
summary: rootless rock tutorial

execute: |

  cp rockcraft-run-user.yaml rockcraft.yaml

  # [docs:build-and-copy-rock]
  rockcraft pack
  sudo rockcraft.skopeo --insecure-policy copy oci-archive:hello-nginx-rootless_latest_amd64.rock docker-daemon:hello-nginx-rootless:latest
  # [docs:build-and-copy-rock-end]

  rm hello-nginx-rootless_latest_amd64.rock

  # [docs:docker-run]
  docker run --rm -d -p 80:80 --name hello-nginx-rootless hello-nginx-rootless:latest
  # [docs:docker-run-end]

  # [docs:test-rock]
  curl http://localhost
  # [docs:test-rock-end]

  curl http://localhost | grep "Hello World! From a Rock!"

  docker stop hello-nginx-rootless
  rockcraft clean
  rm rockcraft.yaml


  cp rockcraft-new-user.yaml rockcraft.yaml

  # [docs:build-and-copy-manual-rock]
  rockcraft pack
  sudo rockcraft.skopeo --insecure-policy copy oci-archive:hello-nginx-rootless_latest_amd64.rock docker-daemon:hello-nginx-rootless:latest
  # [docs:build-and-copy-manual-rock-end]

  rm hello-nginx-rootless_latest_amd64.rock

  # [docs:docker-run-manual-rock]
  docker run --rm -d -p 80:80 --name hello-nginx-rootless hello-nginx-rootless:latest
  # [docs:docker-run-manual-rock-end]

  # [docs:test-manual-rock]
  curl http://localhost
  # [docs:test-manual-rock-end]

  curl http://localhost | grep "Hello World! From a Rock!"

  docker stop hello-nginx-rootless
  rm rockcraft.yaml
