summary: flask extension WSGI auto-discovery test
environment:
  # Rock-name module with canonical Flask `app` attribute
  MODULE/rock_app_bare: rock_name
  FILE/rock_app_bare: app.py
  APP_FILE/rock_app_bare: case_app_var.py
  WSGI_PATH/rock_app_bare: rock_name.app:app
  BASE/rock_app_bare: bare

  MODULE/rock_app_2204: rock_name
  FILE/rock_app_2204: app.py
  APP_FILE/rock_app_2204: case_app_var.py
  WSGI_PATH/rock_app_2204: rock_name.app:app
  BASE/rock_app_2204: ubuntu-22.04

  MODULE/rock_app_2404: rock_name
  FILE/rock_app_2404: app.py
  APP_FILE/rock_app_2404: case_app_var.py
  WSGI_PATH/rock_app_2404: rock_name.app:app
  BASE/rock_app_2404: ubuntu-24.04

  # Factory discovery from nested module
  MODULE/create_app_main_bare: app
  FILE/create_app_main_bare: main.py
  APP_FILE/create_app_main_bare: case_create_app_factory.py
  WSGI_PATH/create_app_main_bare: app.main:create_app()
  BASE/create_app_main_bare: bare

  MODULE/create_app_main_2204: app
  FILE/create_app_main_2204: main.py
  APP_FILE/create_app_main_2204: case_create_app_factory.py
  WSGI_PATH/create_app_main_2204: app.main:create_app()
  BASE/create_app_main_2204: ubuntu-22.04

  MODULE/create_app_main_2404: app
  FILE/create_app_main_2404: main.py
  APP_FILE/create_app_main_2404: case_create_app_factory.py
  WSGI_PATH/create_app_main_2404: app.main:create_app()
  BASE/create_app_main_2404: ubuntu-24.04

execute: |
  ROCK_NAME="flask-discovery"
  NORMALIZED_NAME="flask_discovery"
  BASE="${BASE:-ubuntu-22.04}"

  # Create temp directory for test
  mkdir -p test_workspace
  cd test_workspace

  cp ../requirements.txt .

  # Determine target directory based on MODULE
  if [ -z "${MODULE:-}" ]; then
    TARGET_DIR="."
  elif [ "${MODULE}" = "rock_name" ]; then
    TARGET_DIR="${NORMALIZED_NAME}"
  else
    TARGET_DIR="${MODULE}"
  fi

  mkdir -p "${TARGET_DIR}"
  cp "../${APP_FILE}" "${TARGET_DIR}/${FILE}"

  run_rockcraft init --name "${ROCK_NAME}" --profile flask-framework

  # Align base/build-base with the scenario under test
  if [ "${BASE}" = "bare" ]; then
    sed -i "s/base: .*/base: ${BASE}\nbuild-base: ubuntu@22.04/g" rockcraft.yaml
  else
    sed -i "s/base: .*/base: ${BASE//-/@}/g" rockcraft.yaml
  fi

  run_rockcraft expand-extensions > expanded.yaml

  # WSGI path in environment, replace rock_name with normalized name if used
  EXPECTED=$(echo "${WSGI_PATH}" | sed "s/rock_name/${NORMALIZED_NAME}/")

  # Validate WSGI path in expanded YAML
  if ! grep -q "'${EXPECTED}'" expanded.yaml; then
    echo "ERROR: Expected WSGI path '${EXPECTED}' not found in expanded YAML"
    echo "Service command:"
    grep "command:" expanded.yaml
    exit 1
  fi

  echo "Successfully validated WSGI path: ${EXPECTED}"

restore: |
  rm -rf test_workspace
