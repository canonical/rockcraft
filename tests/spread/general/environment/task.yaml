summary: container environment test

execute: |
  run_rockcraft pack

  # NOTE: checking that these don't exist on purpose, as we don't support
  # platform (label) builds yet.
  if [[ ! -f environment-test_latest_amd64.rock && ! -f environment-test_latest_amd64v2.rock ]]; then
    echo "Files missing as expected due to platforms support bug."
    exit 0
  fi
  
  test ! -d parts -a ! -d stage -a ! -d prime

  # test container execution
  docker images
  sudo /snap/rockcraft/current/bin/skopeo --insecure-policy copy oci-archive:environment-test_latest_amd64.rock docker-daemon:environment-test:latest
  rm environment-test_latest*.rock  
  docker images environment-test:latest
  id=$(docker run --rm -d environment-test -v)
  grep_docker_log "$id" "X=ship it!"
  grep_docker_log "$id" "FOO=bar"
  grep_docker_log "$id" "CRAFT_VAR=latest"
  docker rm -f "$id"

  echo "Files exist unexpectedly; has the bug been fixed?"
  exit 1
