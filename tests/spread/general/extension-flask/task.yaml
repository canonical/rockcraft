summary: flask extension test

execute: |
  export ROCKCRAFT_ENABLE_EXPERIMENTAL_EXTENSIONS=true
  
  run_rockcraft pack

  test -f flask-extension_0.1_amd64.rock
  test ! -d work

  # Ensure docker does not have this container image
  docker rmi --force flask-extension
  # Install container
  sudo /snap/rockcraft/current/bin/skopeo --insecure-policy copy oci-archive:flask-extension_0.1_amd64.rock docker-daemon:flask-extension:latest
  # Ensure container exists
  docker images flask-extension | MATCH "flask-extension"
  
  # ensure container doesn't exist
  docker rm -f flask-extension-container
  
  # test the flask project is ready to run inside the container
  docker run --rm --entrypoint /bin/python3 flask-extension -m gunicorn --chdir /srv/flask/app --check-config app:app
  docker run --rm --entrypoint /bin/python3 flask-extension -c "import pathlib;assert pathlib.Path('/srv/flask/app/static/js/test.js').is_file()"
  docker run --rm --entrypoint /bin/python3 flask-extension -c "import pathlib;assert not pathlib.Path('/srv/flask/app/node_modules').exists()"

restore: |
  rm -f flask-extension_0.1_amd64.rock
  docker rmi -f flask-extension
