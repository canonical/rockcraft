[tox]
envlist = py38

[testenv]
setenv =
    PYTHONPATH = {toxinidir}
deps =
    -r{toxinidir}/requirements-dev.txt
    -r{toxinidir}/requirements.txt
commands =
    pip install -U pip
    pytest --basetemp={envtmpdir}

[testenv:docs]
commands = make docs

[testenv:lint]
commands = make lint

[testenv:integrations]
commands = make test-integrations

[testenv:units]
commands = make test-units

[pycodestyle]
ignore = E501

[testenv:build-snap]
base =
skip_install = true
labels = test, test-spread
allowlist_externals = snapcraft
commands = snapcraft --use-lxd

[testenv:test-spread]
base =
depends = build-snap
skip_install = true
labels = test, test-spread
allowlist_externals = git, spread
commands_pre =
    python -c "import os, pathlib, shutil;shutil.copy(sorted(pathlib.Path().glob('rockcraft_*.snap'), key=os.path.getmtime, reverse=True)[0], 'tests/rockcraft_spread.snap')"
    git submodule init
    git submodule update
commands = spread {posargs:tests/spread/}
